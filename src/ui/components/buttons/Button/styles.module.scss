@use "@/ui/tokens" as tokens;

@layer components {
    .button {
        // CSS Variables
        --button-accent: var(--color-primary);
        --button-accent-dark: color-mix(
            in srgb,
            var(--button-accent) 70%,
            black
        );
        --button-bg: var(--color-block);
        --button-ink: var(--color-ink);
        --button-outline-color: var(--color-ink);
        --button-radius: var(--radius-quirky-sm);
        --button-overlay:
            repeating-radial-gradient(
                circle at 0 0,
                color-mix(in srgb, var(--button-accent) 20%, white) 0 1px,
                transparent 1px 5px
            ),
            radial-gradient(
                circle at 18% 30%,
                rgb(255 255 255 / 6%),
                transparent 55%
            );
        --size-y: 0.65rem;
        --size-x: 1.45rem;

        // Quirky border radius with offset for outline
        // Base: 0.4rem 1rem 0.4rem 0.4rem + 0.45rem gap
        --outline-radius: 0.85rem 1.45rem 0.85rem 0.85rem;

        // Base styles
        position: relative;
        display: inline-flex;
        align-items: stretch;
        justify-content: center;
        border: none;
        cursor: pointer;
        appearance: none;
        isolation: isolate;
        min-height: 2.9rem;

        // Typography
        font-family: var(--font-family);
        font-weight: 700;
        font-size: 0.95rem;
        line-height: 1.1;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        color: var(--button-ink);
        text-decoration: none;

        // Visual styling
        background:
            linear-gradient(120deg, rgb(255 255 255 / 12%), transparent 60%),
            var(--button-bg);
        background-blend-mode: screen;
        border-radius: var(--button-radius);
        overflow: visible;

        @include tokens.border-standard;
        @include tokens.radius-quirky-sm;
        @include tokens.shadow-md;
        @include tokens.rotate-slight;

        // Transitions
        transition:
            translate 220ms var(--spring-bezier),
            box-shadow 220ms var(--spring-bezier),
            background 220ms ease,
            color 180ms ease,
            filter 180ms ease;
    }

    // Overlay effect
    .button::before {
        content: "";
        position: absolute;
        inset: 0.25rem;
        border-radius: inherit;
        background: var(--button-overlay, none);
        opacity: 0.55;
        mix-blend-mode: soft-light;
        pointer-events: none;
        transition: opacity 200ms ease;
        z-index: 1;
    }

    // Hover states
    .button:where(:not(:disabled)):hover {
        box-shadow: 10px 10px 0 var(--color-ink);
        translate: 0 -2px;

        &::before {
            opacity: 0.85;
        }

        .icon {
            transform: translateY(-1px);
        }
    }

    // Active states
    .button:where(:not(:disabled)):active {
        translate: 1.5px 1.5px;
        box-shadow: 4px 4px 0 var(--color-ink);

        &::before {
            opacity: 0.65;
        }

        .icon {
            transform: translateY(1px) scale(0.95);
        }

        .activeOutline {
            opacity: 1;

            &::before {
                animation-play-state: running;
            }
        }
    }

    // Focus state
    .button:focus-visible {
        outline: 3px solid var(--color-primary);
        outline-offset: 4px;
    }

    // Stacked icon variant
    .button:has(.stack) {
        min-height: 3.6rem;
    }

    // Content wrapper
    .content {
        position: relative;
        z-index: 2;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: var(--size-y, 0.65rem) var(--size-x, 1.45rem);
        gap: clamp(0.35rem, 1vw, 0.75rem);
        text-align: center;

        &.stack {
            flex-direction: column;
            gap: var(--spacing-xs);

            .label {
                text-wrap: balance;
            }

            .icon {
                font-size: 1.35em;
            }
        }

        &.withIcon {
            gap: var(--spacing-xs);
        }
    }

    // Icon styles
    .icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05em;
        filter: drop-shadow(-2px 2px 0 rgb(0 0 0 / 25%));
        transition: transform 200ms var(--spring-bezier);
    }

    // Label
    .label {
        line-height: 1.1;
    }

    // Full width variant
    .fullWidth {
        width: 100%;
    }

    // Active outline (animated border on press)
    .activeOutline {
        --outline-gap: 0.55rem;
        --outline-width: 5px;

        position: absolute;
        inset: calc(-1 * var(--outline-gap));
        pointer-events: none;
        display: block;
        opacity: 0;
        transition: opacity 160ms ease;
        z-index: 0;

        // Animated gradient border
        &::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -2;
            border-radius: calc(var(--radius-quirky-sm-tl) + var(--outline-gap))
                calc(var(--radius-quirky-sm-tr) + var(--outline-gap))
                calc(var(--radius-quirky-sm-br) + var(--outline-gap))
                calc(var(--radius-quirky-sm-bl) + var(--outline-gap));
            background: repeating-linear-gradient(
                125deg,
                var(--button-outline-color) 0 2px,
                transparent 2px 4px
            );
            animation: dash-slide 900ms linear infinite;
            animation-play-state: paused;
        }

        // Cover the center to create outline-only effect
        &::after {
            content: "";
            position: absolute;
            inset: var(--outline-width);
            z-index: -1;
            border-radius: var(--button-radius);
            background: color-mix(
                in srgb,
                var(--button-accent) 70%,
                transparent
            );
        }
    }

    // ========================================
    // VARIANT: PRIMARY
    // ========================================
    .button[data-variant="primary"] {
        --button-bg: linear-gradient(
            135deg,
            var(--button-accent) 0% 15%,
            color-mix(in srgb, var(--button-accent) 98%, white) 15% 40%,
            color-mix(in srgb, var(--button-accent) 95%, white) 40% 55%,
            color-mix(in srgb, var(--button-accent) 95%, black) 55% 75%,
            var(--button-accent-dark) 75% 100%
        );
        --button-ink: var(--color-bg);
        --button-outline-color: color-mix(
            in srgb,
            var(--color-bg) 80%,
            transparent
        );

        box-shadow: 9px 9px 0 var(--color-ink);
        border-color: var(--button-accent-dark);

        &:where(:not(:disabled)):active {
            box-shadow: 5px 5px 0 var(--color-ink);
        }

        --button-overlay:
            radial-gradient(
                circle at 12% 38%,
                color-mix(in srgb, var(--button-accent) 12%, white),
                transparent 58%
            ),
            radial-gradient(
                circle at 80% 15%,
                color-mix(in srgb, var(--button-accent-dark) 70%, black),
                transparent 48%
            ),
            repeating-radial-gradient(
                circle at 0 0,
                rgb(0 0 0 / 8%) 0 2px,
                transparent 2px 6px
            );
    }

    // ========================================
    // VARIANT: SECONDARY
    // ========================================
    .button[data-variant="secondary"] {
        --button-bg: transparent;
        --button-ink: var(--button-accent);
        --button-outline-color: color-mix(
            in srgb,
            var(--button-accent) 50%,
            transparent
        );
        --button-overlay: none;

        border-color: var(--button-accent);
        box-shadow: 4px 4px 0
            color-mix(in srgb, var(--button-accent) 35%, black);

        &::before {
            display: none;
        }

        // Active state - turn text and border white (accent stays red)
        &:where(:not(:disabled)):active {
            --button-ink: white;
            --button-outline-color: color-mix(in srgb, white 50%, transparent);

            color: white;
            border-color: white;

            .activeOutline::after {
                background: color-mix(
                    in srgb,
                    var(--button-accent) 90%,
                    transparent
                );
            }
        }
    }

    // ========================================
    // VARIANT: GHOST
    // ========================================
    .button[data-variant="ghost"] {
        --button-bg: transparent;
        --button-ink: var(--button-accent);
        --button-outline-color: color-mix(
            in srgb,
            var(--button-accent) 40%,
            transparent
        );
        --button-overlay: none;

        border: none;
        box-shadow: none;
        background: transparent;

        &::before {
            display: none;
        }

        &:where(:not(:disabled)):hover {
            text-shadow: 0 2px 0 rgb(0 0 0 / 35%);
        }

        &:where(:not(:disabled)):active {
            translate: 0;
        }

        // Ghost variant fills the entire button on active
        .activeOutline {
            inset: 0;
            z-index: 0;

            &::before {
                border-radius: var(--button-radius);
                border: none;
                background-image: repeating-linear-gradient(
                    125deg,
                    var(--button-outline-color) 0 2px,
                    transparent 2px 4px
                );
                background-origin: border-box;
                background-clip: border-box;
            }

            // Ghost doesn't need the center cover
            &::after {
                display: none;
            }
        }
    }

    // ========================================
    // STATE: DISABLED
    // ========================================
    .button:disabled {
        --button-bg: var(--color-block-muted);
        --button-outline-color: rgb(0 0 0 / 40%);

        color: rgb(0 0 0 / 45%);
        border: 3px solid rgb(0 0 0 / 25%);
        box-shadow: none;
        translate: 0;
        pointer-events: none;
        filter: grayscale(20%);
        background: var(--color-block-muted);

        &::before {
            opacity: 0.5;
            mix-blend-mode: multiply;

            @include tokens.pattern-stripes-diagonal;
        }

        .activeOutline {
            opacity: 0;
        }
    }

    // ========================================
    // SIZE VARIANTS
    // ========================================
    .button[data-size="md"] {
        --size-y: 0.75rem;
        --size-x: 1.75rem;

        font-size: 0.95rem;
    }

    .button[data-size="lg"] {
        --size-y: 1rem;
        --size-x: 2.35rem;

        font-size: 1.1rem;
        letter-spacing: 0.12em;
    }
}

@keyframes dash-slide {
    to {
        background-position: 4px 4px;
    }
}
